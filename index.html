<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Tunlr Clone by corporate-gadfly</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>Tunlr Clone</h1>
        <p>Use a cheap VPS to make a Tunlr Clone</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/corporate-gadfly/Tunlr-Clone" class="button fork"><strong>View On GitHub</strong></a>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>
<a name="tunlr-clone" class="anchor" href="#tunlr-clone"><span class="octicon octicon-link"></span></a>Tunlr Clone</h1>

<p>To build a tunlr or UnoTelly or unblock-us.com (or other DNS-based services) clone on the cheap, you need to invest in a VPS.
For the purposes of this discussion, I am assuming that you will be using this for watching <strong>non-https</strong> US geo-locked content.</p>

<h2>
<a name="vps-provider-specific-terminology" class="anchor" href="#vps-provider-specific-terminology"><span class="octicon octicon-link"></span></a>VPS Provider Specific Terminology</h2>

<p>My VPS provider is <a href="http://buyvm.net/">buyvm</a>. I have an OpenVZ 128m plan with them hosted in New York (running Debian 7). So, the venet0 references that
you will see pertain to that VPS provider.</p>

<h2>
<a name="disclaimer" class="anchor" href="#disclaimer"><span class="octicon octicon-link"></span></a>Disclaimer</h2>

<p>This information is provided as is without warranty of any kind, either express or implied, including but not limited to the implied warranties of merchantability and fitness for a particular purpose. In no event shall the author be liable for any damages whatsoever including direct, indirect, incidental consequential, loss of business profits, or special damages.</p>

<p>If you leave your DNS server or Squid proxy server wide open to abuse, that's on your own head. Take precautions in this regard. Proceed at your own risk.</p>

<p>Also this is not meant to be a hold-your-hand start from scratch tutorial. Therefore, some level of Linux expertise is necessary.</p>

<h2>
<a name="background" class="anchor" href="#background"><span class="octicon octicon-link"></span></a>Background</h2>

<p>Basically we are interested in proxying content only for certain domains. The actual streaming media sits on CDN
networks and is usually not geo-locked. The amount of proxying we'll end up doing will be relatively
insignificant compared to a VPN-based setup.
<a href="https://raw.github.com/corporate-gadfly/Tunlr-Clone/master/tunlr-clone.png"><img src="https://raw.github.com/corporate-gadfly/Tunlr-Clone/master/tunlr-clone.png" alt="How Tunlr Cloning works"></a></p>

<h2>
<a name="us-ip-address" class="anchor" href="#us-ip-address"><span class="octicon octicon-link"></span></a>US IP Address</h2>

<p>Your VPS provider must provide you with a US IP address</p>

<h2>
<a name="tomato-based-router" class="anchor" href="#tomato-based-router"><span class="octicon octicon-link"></span></a>Tomato based router</h2>

<p>Since you will be changing DNS servers to point to your "own" DNS, it makes sense to run <code>dnsmasq</code> on your router,
therefore having a Tomato capable router is preferable.</p>

<p>Following is my <code>dnsmasq</code> configuration on my Tomato-based router (running a Toastman build):
<code>Advanced -&gt; DHCP/DNS -&gt; Dnsmasq Custom configuration</code></p>

<div class="highlight"><pre><span class="c"># Never forward plain names (without a dot or domain part)</span>
domain-needed
<span class="c"># Never forward addresses in the non-routed address spaces.</span>
bogus-priv

<span class="c"># If you don't want dnsmasq to read /etc/resolv.conf or any other</span>
<span class="c"># file, getting its servers from this file instead (see below), then</span>
<span class="c"># uncomment this.</span>
no-resolv

<span class="c"># If you don't want dnsmasq to poll /etc/resolv.conf or other resolv</span>
<span class="c"># files for changes and re-read them then uncomment this.</span>
no-poll

<span class="c"># tunlr for hulu</span>
<span class="nv">server</span><span class="o">=</span>/hulu.com/199.x.x.x
<span class="nv">server</span><span class="o">=</span>/huluim.com/199.x.x.x
<span class="c"># tunlr for US networks</span>
<span class="c"># cbs works with link.theplatform.com</span>
<span class="nv">server</span><span class="o">=</span>/abc.com/abc.go.com/199.x.x.x
<span class="nv">server</span><span class="o">=</span>/fox.com/link.theplatform.com/199.x.x.x
<span class="nv">server</span><span class="o">=</span>/nbc.com/nbcuni.com/199.x.x.x
<span class="nv">server</span><span class="o">=</span>/pandora.com/199.x.x.x
<span class="nv">server</span><span class="o">=</span>/ip2location.com/199.x.x.x
<span class="c"># espn3 </span>
<span class="nv">server</span><span class="o">=</span>/broadband.espn.go.com/199.x.x.x

<span class="c"># Google</span>
<span class="nv">server</span><span class="o">=</span>8.8.8.8
<span class="nv">server</span><span class="o">=</span>8.8.4.4
<span class="c"># OpenDNS</span>
<span class="c">#server=208.67.222.222</span>
<span class="c">#server=208.67.220.220</span>
</pre></div>

<p>In essence, I am forwarding DNS queries to my VPS only for the specified domains. Everything else goes to Google DNS
(or can easily go to your ISP DNS).</p>

<h2>
<a name="your-own-dns-server" class="anchor" href="#your-own-dns-server"><span class="octicon octicon-link"></span></a>Your own DNS Server</h2>

<p>I am running bind9 on my VPS to override the DNS resolution for the entire domains mentioned in the Tomato-based router configuration above.
The plan is to send the external IP address of my VPS as the resolved IP address for any of those domains.</p>

<p>Once the web traffic hits my VPS, I use iptables to redirect port 80 traffic to squid running on port 8xxx.</p>

<p>Here is the bind9 config:</p>

<p><code>/etc/bind/named.conf.options</code></p>

<div class="highlight"><pre><span class="k">options</span> <span class="p">{</span>
    <span class="kn">directory</span> <span class="s">"/var/cache/bind"</span><span class="p">;</span>
    <span class="kn">forwarders</span> <span class="p">{</span>
        <span class="c1"># these are the DNS servers from the VPS provider (look in /etc/resolv.conf if yours are different)</span>
        <span class="kn">199.195.255.68</span><span class="p">;</span>
        <span class="kn">199.195.255.69</span><span class="p">;</span>
    <span class="p">}</span>;

    <span class="kn">auth-nxdomain</span> <span class="s">no</span><span class="p">;</span>    <span class="c1"># conform to RFC1035</span>
    <span class="kn">listen-on-v6</span> <span class="p">{</span> <span class="kn">any</span><span class="p">;</span> <span class="p">}</span>;
    <span class="kn">allow-query</span> <span class="p">{</span> <span class="kn">trusted</span><span class="p">;</span> <span class="p">}</span>;
    <span class="kn">allow-recursion</span> <span class="p">{</span> <span class="kn">trusted</span><span class="p">;</span> <span class="p">}</span>;
    <span class="kn">recursion</span> <span class="s">yes</span><span class="p">;</span>
    <span class="kn">dnssec-enable</span> <span class="s">no</span><span class="p">;</span>
    <span class="kn">dnssec-validation</span> <span class="s">no</span><span class="p">;</span>
<span class="p">}</span>;
</pre></div>

<p><code>/etc/bind/named.conf.local</code></p>

<div class="highlight"><pre><span class="k">//</span>
<span class="s">//</span> <span class="s">Do</span> <span class="s">any</span> <span class="s">local</span> <span class="s">configuration</span> <span class="s">here</span>
<span class="s">//</span>

<span class="s">//</span> <span class="s">Consider</span> <span class="s">adding</span> <span class="s">the</span> <span class="mi">1918</span> <span class="s">zones</span> <span class="s">here,</span> <span class="s">if</span> <span class="s">they</span> <span class="s">are</span> <span class="s">not</span> <span class="s">used</span> <span class="s">in</span> <span class="s">your</span>
<span class="s">//</span> <span class="s">organization</span>
<span class="s">//include</span> <span class="s">"/etc/bind/zones.rfc1918"</span><span class="p">;</span>

<span class="k">include</span> <span class="n">"/etc/bind/rndc.key"</span>;

<span class="k">acl</span> <span class="s">"trusted"</span> <span class="p">{</span>
    <span class="kn">172.x.x.x</span><span class="p">;</span>        <span class="kn">//</span> <span class="s">local</span> <span class="n">venet0</span><span class="p">:</span><span class="mi">17</span> <span class="s">internal</span> <span class="s">IP</span> <span class="s">here</span>
    <span class="mi">127</span><span class="s">.0.0.1</span><span class="p">;</span>
    <span class="kn">173.x.x.x</span><span class="p">;</span>        <span class="kn">//</span> <span class="s">Your</span> <span class="s">ISP</span> <span class="s">IP</span> <span class="s">here</span> <span class="s">(cable/DSL)</span>
<span class="err">}</span><span class="p">;</span>

<span class="kn">include</span> <span class="s">"/etc/bind/zones.override"</span><span class="p">;</span>

<span class="kn">logging</span> <span class="p">{</span>
    <span class="kn">channel</span> <span class="s">bind_log</span> <span class="p">{</span>
        <span class="kn">file</span> <span class="s">"/var/log/named/named.log"</span> <span class="s">versions</span> <span class="mi">5</span> <span class="s">size</span> <span class="mi">30m</span><span class="p">;</span>
        <span class="kn">severity</span> <span class="s">info</span><span class="p">;</span>
        <span class="kn">print-time</span> <span class="s">yes</span><span class="p">;</span>
        <span class="kn">print-severity</span> <span class="s">yes</span><span class="p">;</span>
        <span class="kn">print-category</span> <span class="s">yes</span><span class="p">;</span>
    <span class="p">}</span>;
    <span class="kn">category</span> <span class="s">default</span> <span class="p">{</span> <span class="kn">bind_log</span><span class="p">;</span> <span class="p">}</span>;
    <span class="kn">category</span> <span class="s">queries</span> <span class="p">{</span> <span class="kn">bind_log</span><span class="p">;</span> <span class="p">}</span>;
<span class="p">}</span>;
</pre></div>

<p><code>/etc/bind/zones.override</code></p>

<div class="highlight"><pre><span class="k">zone</span> <span class="s">"hulu.com."</span> <span class="p">{</span>
    <span class="kn">type</span> <span class="s">master</span><span class="p">;</span>
    <span class="kn">file</span> <span class="s">"/etc/bind/db.override"</span><span class="p">;</span>
<span class="p">}</span>;
<span class="k">zone</span> <span class="s">"huluim.com."</span> <span class="p">{</span>
    <span class="kn">type</span> <span class="s">master</span><span class="p">;</span>
    <span class="kn">file</span> <span class="s">"/etc/bind/db.override"</span><span class="p">;</span>
<span class="p">}</span>;
<span class="k">zone</span> <span class="s">"abc.com."</span> <span class="p">{</span>
    <span class="kn">type</span> <span class="s">master</span><span class="p">;</span>
    <span class="kn">file</span> <span class="s">"/etc/bind/db.override"</span><span class="p">;</span>
<span class="p">}</span>;
<span class="k">zone</span> <span class="s">"abc.go.com."</span> <span class="p">{</span>
    <span class="kn">type</span> <span class="s">master</span><span class="p">;</span>
    <span class="kn">file</span> <span class="s">"/etc/bind/db.override"</span><span class="p">;</span>
<span class="p">}</span>;
<span class="k">zone</span> <span class="s">"fox.com."</span> <span class="p">{</span>
    <span class="kn">type</span> <span class="s">master</span><span class="p">;</span>
    <span class="kn">file</span> <span class="s">"/etc/bind/db.override"</span><span class="p">;</span>
<span class="p">}</span>;
<span class="k">zone</span> <span class="s">"link.theplatform.com."</span> <span class="p">{</span>
    <span class="kn">type</span> <span class="s">master</span><span class="p">;</span>
    <span class="kn">file</span> <span class="s">"/etc/bind/db.override"</span><span class="p">;</span>
<span class="p">}</span>;
<span class="k">zone</span> <span class="s">"nbc.com."</span> <span class="p">{</span>
    <span class="kn">type</span> <span class="s">master</span><span class="p">;</span>
    <span class="kn">file</span> <span class="s">"/etc/bind/db.override"</span><span class="p">;</span>
<span class="p">}</span>;
<span class="k">zone</span> <span class="s">"nbcuni.com."</span> <span class="p">{</span>
    <span class="kn">type</span> <span class="s">master</span><span class="p">;</span>
    <span class="kn">file</span> <span class="s">"/etc/bind/db.override"</span><span class="p">;</span>
<span class="p">}</span>;
<span class="k">zone</span> <span class="s">"pandora.com."</span> <span class="p">{</span>
    <span class="kn">type</span> <span class="s">master</span><span class="p">;</span>
    <span class="kn">file</span> <span class="s">"/etc/bind/db.override"</span><span class="p">;</span>
<span class="p">}</span>;
<span class="k">zone</span> <span class="s">"broadband.espn.go.com."</span> <span class="p">{</span>
    <span class="kn">type</span> <span class="s">master</span><span class="p">;</span>
    <span class="kn">file</span> <span class="s">"/etc/bind/db.override"</span><span class="p">;</span>
<span class="p">}</span>;
<span class="k">zone</span> <span class="s">"ip2location.com."</span> <span class="p">{</span>
    <span class="kn">type</span> <span class="s">master</span><span class="p">;</span>
    <span class="kn">file</span> <span class="s">"/etc/bind/db.override"</span><span class="p">;</span>
<span class="p">}</span>;
</pre></div>

<p><code>/etc/bind/db.override</code></p>

<pre><code>;
; BIND data file for overridden IPs
;
$TTL  86400
@   IN  SOA ns1 root (
            2012100401  ; serial
            604800      ; refresh 1w
            86400       ; retry 1d
            2419200     ; expiry 4w
            86400       ; minimum TTL 1d
            )

; need atleast a nameserver
    IN  NS  ns1
; specify nameserver IP address
ns1 IN  A   199.y.y.y                ; external IP from venet0:0
; provide IP address for domain itself
@   IN  A   199.y.y.y                ; external IP from venet0:0
; resolve everything with the same IP address as ns1
*   IN  A   199.y.y.y                 ; external IP from venet0:0
</code></pre>

<p>When you discover a new domain that you want to "master", simply add it to the <code>zones.override</code> file and restart bind9.</p>

<h2>
<a name="squid" class="anchor" href="#squid"><span class="octicon octicon-link"></span></a>Squid</h2>

<p><code>/etc/squid3/squid.conf</code></p>

<div class="highlight"><pre><span class="c"># grep '^[^#]' /etc/squid3/squid.conf</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>manager<span class="w"> </span><span class="k">proto</span><span class="w"> </span>cache_object<span class="w"></span>
<span class="k">acl</span><span class="w"> </span>localhost<span class="w"> </span><span class="k">src</span><span class="w"> </span><span class="mf">127.0.0.1/32</span><span class="w"> </span><span class="mf">::1</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>to_localhost<span class="w"> </span><span class="k">dst</span><span class="w"> </span><span class="mf">127.0.0.0/8</span><span class="w"> </span><span class="mf">0.0.0.0/32</span><span class="w"> </span><span class="mf">::1</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>trusted<span class="w"> </span><span class="k">src</span><span class="w"> </span><span class="m">172</span>.x.x.x<span class="w"> </span><span class="m">173</span>.y.y.y<span class="w">        </span><span class="c"># internal IP from venet0:17 and ISP IP (Cable/DSL)</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>SSL_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">443</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">80</span><span class="w">      </span><span class="c"># http</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">21</span><span class="w">      </span><span class="c"># ftp</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">443</span><span class="w">     </span><span class="c"># https</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">70</span><span class="w">      </span><span class="c"># gopher</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">210</span><span class="w">     </span><span class="c"># wais</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">1025-65535</span><span class="w">  </span><span class="c"># unregistered ports</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">280</span><span class="w">     </span><span class="c"># http-mgmt</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">488</span><span class="w">     </span><span class="c"># gss-http</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">591</span><span class="w">     </span><span class="c"># filemaker</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>Safe_ports<span class="w"> </span><span class="k">port</span><span class="w"> </span><span class="m">777</span><span class="w">     </span><span class="c"># multiling http</span><span class="w"></span>
<span class="k">acl</span><span class="w"> </span>CONNECT<span class="w"> </span><span class="k">method</span><span class="w"> </span>CONNECT<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>manager<span class="w"> </span>localhost<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span>manager<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span>!Safe_ports<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span>CONNECT<span class="w"> </span>!SSL_ports<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>trusted<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">allow</span><span class="w"> </span>localhost<span class="w"></span>
<span class="k">http_access</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
<span class="k">http_port</span><span class="w"> </span><span class="mf">0.0.0.0</span>:8128<span class="w"> </span>transparent<span class="w"></span>
<span class="k">hierarchy_stoplist</span><span class="w"> </span>cgi-bin<span class="w"> </span>?<span class="w"></span>
<span class="k">debug_options</span><span class="w"> </span><span class="no">ALL</span>,3<span class="w"></span>
<span class="k">coredump_dir</span><span class="w"> </span>/var/spool/squid3<span class="w"></span>
cache<span class="w"> </span><span class="no">deny</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
<span class="k">refresh_pattern</span><span class="w"> </span>^ftp:<span class="w">       </span><span class="m">1440</span><span class="w">    </span><span class="m">20%</span><span class="w"> </span><span class="m">10080</span><span class="w"></span>
<span class="k">refresh_pattern</span><span class="w"> </span>^gopher:<span class="w">    </span><span class="m">1440</span><span class="w">    </span><span class="m">0%</span><span class="w">  </span><span class="m">1440</span><span class="w"></span>
<span class="k">refresh_pattern</span><span class="w"> </span>-i<span class="w"> </span>(/cgi-bin/|\?)<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0%</span><span class="w">  </span><span class="m">0</span><span class="w"></span>
<span class="k">refresh_pattern</span><span class="w"> </span>.<span class="w">       </span><span class="m">0</span><span class="w">   </span><span class="m">20%</span><span class="w"> </span><span class="m">4320</span><span class="w"></span>
request_header_access<span class="w"> </span>Proxy-Connection<span class="w"> </span><span class="no">deny</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
request_header_access<span class="w"> </span>X-Forwarded-For<span class="w"> </span><span class="no">deny</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
request_header_access<span class="w"> </span>Connection<span class="w"> </span><span class="no">deny</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
request_header_access<span class="w"> </span><span class="no">Via</span><span class="w"> </span><span class="no">deny</span><span class="w"> </span><span class="no">all</span><span class="w"></span>
<span class="k">forwarded_for</span><span class="w"> </span><span class="no">off</span><span class="w"></span>
</pre></div>

<h2>
<a name="iptables" class="anchor" href="#iptables"><span class="octicon octicon-link"></span></a>Iptables</h2>

<p><code>172.x.x.x</code> is the venet0:17 internal IP address. </p>

<p>For the <code>filter</code> table (which is the default):</p>

<div class="highlight"><pre>iptables -A INPUT -i venet0 -d 172.x.x.x -p tcp -m tcp --dport 8128 -j ACCEPT
</pre></div>

<p>For the <code>nat</code> table:</p>

<div class="highlight"><pre>iptables -t nat -A PREROUTING -i venet0 -p tcp --dport 80 -j DNAT --to 172.x.x.x:8128
</pre></div>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/corporate-gadfly">corporate-gadfly</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
